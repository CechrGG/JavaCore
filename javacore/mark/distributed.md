## 分布式事务

### 事务 Transaction

#### 基于关系型数据库的本地事务

* __原子性 Atomicity__: 必须是原子工作单元，一次执行只允许两种结果状态之一，要么成功，要么失败
* __一致性 Consistency__: 必须保证数据的一致性，只能从一个一致性状态到另一个一致性状态
* __隔离性 Isolation__: 并发事务之间相互隔离，一个事务不能被其他并发事务干扰
* __持久性 Durability__: 一旦提交对数据的改变是永久性的

#### 事务的隔离级别
* __读未提交 Read Uncommitted__: 一个事务能够读到另一个事务未提交的数据，读不加锁，写加写锁，可能造成**脏读**
* __读提交 Read Committed__: 一个事务提交之后，它的变更才能被其他事务读到，读不加锁，写加读写锁，解决了**脏读**，却还可能造成**不可重复读**问题
* __可重复读 Repeatable Read__: 一个事务执行过程中看到的数据，与事务启动时看到的数据总是一致的，未提交对其他事务也不可见，读加写锁，写加读写锁，还有可能**幻读**
* __串行化 Serializable__: 严格事务隔离，事务只能一个一个序列化执行，不能并发，解决了以上所有问题，却牺牲了性能，一般很少用

#### 分布式事务
> 分布式事务是在分布式系统当中事务的参与者、支持事务的服务器、资源服务器及事务管理器
> 分布在不同的节点上，此时完成事务就需要服务与服务之间远程协作来实现,例如
* 跨数据源的分布式事务
* 跨服务的分布式事务
* 综合情况等

##### X/Open 分布式事务模型
> X/Open DTP(X/Open Distributed Transaction Processing Reference Model) X/Open组织
> 定义的一套分布式事务标准。提出使用两阶段提交(2PC, Two-Phase-Commit)来保证分布式事务的完整性。三种角色
* AP: Application 应用程序
* RM: Resource Manager 资源管理器，比如数据库
* TM: Transaction Manager 事务管理器
> TM 与多个RM之间的事务控制，基于XA协议(XA Specification)来完成。XA协议时X/Open提出的分布式事务处理规范
> 也是分布式事务处理的工业标准。目前Oracle、Mysql、DB2都实现了该规范。

###### 两阶段提交
* 准备阶段：TM通知RM准备分支事务，记录事务日志，并返回准备结果
* 提交/回滚阶段：只要有一个RM不成功则所有都回滚
> 存在的问题
* 阻塞
* 过于保守
* 数据不一致问题： 只有一部分RM收到commit
###### 三阶段提交 主要引入超时中止机制
* CanCommit(询问阶段)
* PreCommit(准备阶段)
* DoCommit(提交或回滚)

##### CAP定理
> CAP定理，又叫布鲁尔定理。指分布式系统中不可能同时满足
> * 一致性(Consistency)
> * 可用性(Availability)
> * 分区容错性(Partition Tolerance)
>  
> 这三个基本需求，最多同时满足两个。
* 原因：网络通信并不绝对可靠
* P是必然存在的，分区故障时如果要保证数据一致性，必须拒绝客户端请求，但如果拒绝客户请求就不能保证可用性。
* 只能是AP或者CP
* AP: 放弃强一致，实现最终一致性，很多互联网公司的主要选择
* CP: 放弃高可用，实现强一致性。如前面的两阶和三阶提交

##### BASE理论
> BASE 理论是由于CAP中一致性和可用性的不可兼得而衍生出来的一种新思想，核心思想是通过牺牲数据的强一致性来获得高可用性。
* Basically Availiable(基本可用)：允许损失一部分功能的可用性来保障核心功能可用
* Soft State(软状态)：允许系统中数据存在中间态，这个状态不影响可用性
* Eventually Consistent(最终一致性)：中间态数据经过一段时间后会达到最终的数据一致性

##### 常见解决方案
* TCC(Try-Confirm-Cancel) 补偿方案
* 可靠性消息方案：利用消息中间件(kafka、RocketMQ、RabbitMQ等)
* 最大努力通知

####Seata 分布式事务框架